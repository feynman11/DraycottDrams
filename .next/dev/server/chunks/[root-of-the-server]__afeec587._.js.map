{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 142, "column": 0}, "map": {"version":3,"sources":["file:///home/tom/code/DraycottDrams/db/schema.ts"],"sourcesContent":["import { pgTable, text, timestamp, integer, decimal, jsonb, boolean, uuid } from \"drizzle-orm/pg-core\";\nimport { createInsertSchema, createSelectSchema } from \"drizzle-zod\";\nimport { z } from \"zod\";\n\n// Enums\nexport const UserRole = {\n  PUBLIC: \"public\",\n  USER: \"user\",\n  MEMBER: \"member\",\n  ADMIN: \"admin\",\n} as const;\n\nexport const ParticipationStatus = {\n  REGISTERED: \"registered\",\n  ATTENDED: \"attended\",\n  NO_SHOW: \"no_show\",\n} as const;\n\n// Tables\nexport const users = pgTable(\"users\", {\n  id: text(\"id\").primaryKey().$defaultFn(() => crypto.randomUUID()),\n  email: text(\"email\").unique().notNull(),\n  emailVerified: timestamp(\"email_verified\", { mode: \"date\" }),\n  name: text(\"name\"),\n  image: text(\"image\"),\n  role: text(\"role\").$default(() => UserRole.USER).notNull(),\n  lastLogin: timestamp(\"last_login\", { mode: \"date\" }),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n});\n\nexport const whiskies = pgTable(\"whiskies\", {\n  id: text(\"id\").primaryKey().$defaultFn(() => crypto.randomUUID()),\n  name: text(\"name\").notNull(),\n  distillery: text(\"distillery\").notNull(),\n  region: text(\"region\").notNull(),\n  country: text(\"country\").notNull(),\n  type: text(\"type\").notNull(),\n  abv: decimal(\"abv\", { precision: 4, scale: 1 }).notNull(),\n  age: integer(\"age\"),\n  priceRange: text(\"price_range\"),\n  description: text(\"description\").notNull(),\n  tastingNotes: jsonb(\"tasting_notes\").$type<string[]>().notNull(),\n  coordinates: jsonb(\"coordinates\").$type<[number, number]>().notNull(), // [longitude, latitude]\n  flavorProfile: jsonb(\"flavor_profile\").$type<{\n    peat: number;\n    fruit: number;\n    floral: number;\n    spice: number;\n    wood: number;\n    sweetness: number;\n  }>().notNull(),\n  imageUrl: text(\"image_url\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n});\n\nexport const tastings = pgTable(\"tastings\", {\n  id: text(\"id\").primaryKey().$defaultFn(() => crypto.randomUUID()),\n  userId: text(\"user_id\").references(() => users.id, { onDelete: \"cascade\" }).notNull(),\n  whiskyId: text(\"whisky_id\").references(() => whiskies.id, { onDelete: \"cascade\" }).notNull(),\n  rating: integer(\"rating\").notNull(),\n  notes: text(\"notes\"),\n  tastingDate: timestamp(\"tasting_date\", { mode: \"date\" }).notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n});\n\nexport const tastingNotes = pgTable(\"tasting_notes\", {\n  id: text(\"id\").primaryKey().$defaultFn(() => crypto.randomUUID()),\n  tastingId: text(\"tasting_id\").references(() => tastings.id, { onDelete: \"cascade\" }).notNull(),\n  note: text(\"note\").notNull(),\n  intensity: integer(\"intensity\").notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\n// Zod schemas for validation\nexport const insertUserSchema = createInsertSchema(users);\nexport const selectUserSchema = createSelectSchema(users);\n\nexport const insertWhiskySchema = createInsertSchema(whiskies);\n\nexport const selectWhiskySchema = createSelectSchema(whiskies);\n\nexport const insertTastingSchema = createInsertSchema(tastings);\nexport const selectTastingSchema = createSelectSchema(tastings);\n\nexport const insertTastingNoteSchema = createInsertSchema(tastingNotes);\nexport const selectTastingNoteSchema = createSelectSchema(tastingNotes);\n\n// Types\nexport type User = typeof users.$inferSelect;\nexport type NewUser = typeof users.$inferInsert;\n\nexport type Whisky = typeof whiskies.$inferSelect;\nexport type NewWhisky = typeof whiskies.$inferInsert;\n\nexport type Tasting = typeof tastings.$inferSelect;\nexport type NewTasting = typeof tastings.$inferInsert;\n\nexport type TastingNote = typeof tastingNotes.$inferSelect;\nexport type NewTastingNote = typeof tastingNotes.$inferInsert;\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 265, "column": 0}, "map": {"version":3,"sources":["file:///home/tom/code/DraycottDrams/lib/db.ts"],"sourcesContent":["import { drizzle } from \"drizzle-orm/postgres-js\";\nimport postgres from \"postgres\";\nimport * as schema from \"@/db/schema\";\n\n// Database connection\nconst connectionString = process.env.DATABASE_URL!;\n\n// Create the connection\nconst client = postgres(connectionString, { prepare: false });\n\n// Create the drizzle instance\nexport const db = drizzle(client, { schema });\n\n// Export for testing/cleanup\nexport { client };\n"],"names":[],"mappings":";;;;;;AAAA;AACA;AACA;;;;AAEA,sBAAsB;AACtB,MAAM,mBAAmB,QAAQ,GAAG,CAAC,YAAY;AAEjD,wBAAwB;AACxB,MAAM,SAAS,IAAA,qJAAQ,EAAC,kBAAkB;IAAE,SAAS;AAAM;AAGpD,MAAM,KAAK,IAAA,uKAAO,EAAC,QAAQ;IAAE,QAAA;AAAO"}},
    {"offset": {"line": 291, "column": 0}, "map": {"version":3,"sources":["file:///home/tom/code/DraycottDrams/lib/auth.ts"],"sourcesContent":["import NextAuth from \"next-auth\";\nimport GoogleProvider from \"next-auth/providers/google\";\nimport { db } from \"@/lib/db\";\nimport { users } from \"@/db/schema\";\nimport { eq } from \"drizzle-orm\";\n\nexport const authOptions = {\n  providers: [\n    GoogleProvider({\n      clientId: process.env.GOOGLE_CLIENT_ID!,\n      clientSecret: process.env.GOOGLE_CLIENT_SECRET!,\n    }),\n  ],\n  callbacks: {\n    async signIn({ user, account, profile }: any) {\n      // If signing in with OAuth (Google), create or update user in database\n      if (account?.provider === \"google\" && user.email) {\n        try {\n          const existingUser = await db\n            .select()\n            .from(users)\n            .where(eq(users.email, user.email))\n            .limit(1);\n\n          if (existingUser.length === 0) {\n            // Create new user for OAuth\n            await db.insert(users).values({\n              id: user.id,\n              email: user.email,\n              name: user.name || null,\n              image: user.image || null,\n              emailVerified: new Date(),\n            });\n          } else {\n            // Update existing user with OAuth info if needed\n            await db\n              .update(users)\n              .set({\n                name: user.name || existingUser[0].name,\n                image: user.image || existingUser[0].image,\n                emailVerified: existingUser[0].emailVerified || new Date(),\n              })\n              .where(eq(users.email, user.email));\n          }\n        } catch (error) {\n          console.error(\"Error creating/updating user:\", error);\n          return false;\n        }\n      }\n\n      return true;\n    },\n    async session({ session, token }: any) {\n      // Verify user still exists before allowing session\n      if (!token.sub) {\n        // Token was invalidated (user deleted), don't set user id/role\n        return session;\n      }\n\n      try {\n        const dbUser = await db\n          .select({ id: users.id, role: users.role })\n          .from(users)\n          .where(eq(users.id, token.sub))\n          .limit(1);\n\n        if (dbUser.length === 0) {\n          // User was deleted, don't set user id/role (session will be invalid)\n          return session;\n        }\n\n        if (session.user) {\n          session.user.id = token.sub;\n          session.user.role = dbUser[0].role;\n        }\n      } catch (error) {\n        console.error(\"Error verifying user in session callback:\", error);\n        // On error, don't set user id/role\n      }\n      return session;\n    },\n    async jwt({ token, user, account }: any) {\n      // On initial sign in, set the user ID and role, and update lastLogin\n      if (user) {\n        // For OAuth users, fetch user ID and role from database and update lastLogin\n        if (account?.provider === \"google\" && user.email) {\n          try {\n            const dbUser = await db\n              .select({ id: users.id, role: users.role })\n              .from(users)\n              .where(eq(users.email, user.email))\n              .limit(1);\n\n            if (dbUser.length > 0) {\n              token.sub = dbUser[0].id;\n              token.role = dbUser[0].role;\n              // Update lastLogin\n              await db\n                .update(users)\n                .set({ lastLogin: new Date() })\n                .where(eq(users.id, dbUser[0].id));\n            } else {\n              console.error(`User ${user.email} not found in database after OAuth login`);\n            }\n          } catch (error) {\n            console.error(\"Error fetching user from database:\", error);\n          }\n        }\n      }\n\n      // On subsequent requests, verify the user still exists and refresh role\n      if (token.sub && !user) {\n        try {\n          const dbUser = await db\n            .select({ id: users.id, role: users.role })\n            .from(users)\n            .where(eq(users.id, token.sub))\n            .limit(1);\n\n          if (dbUser.length === 0) {\n            // User was deleted, clear the token\n            token.sub = undefined;\n            token.role = undefined;\n            console.warn(`User ${token.sub} not found in database, clearing token`);\n          } else {\n            // Refresh role in case it changed\n            token.role = dbUser[0].role;\n          }\n        } catch (error) {\n          console.error(\"Error verifying user in database:\", error);\n        }\n      }\n\n      return token;\n    },\n  },\n  pages: {\n    signIn: \"/signin\",\n  },\n  session: {\n    strategy: \"jwt\" as const,\n  },\n};\n\nconst auth = NextAuth(authOptions);\n\nexport default auth;\nexport { auth };\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 433, "column": 0}, "map": {"version":3,"sources":["file:///home/tom/code/DraycottDrams/app/api/auth/%5B...nextauth%5D/route.ts"],"sourcesContent":["import { authOptions } from \"@/lib/auth\";\nimport NextAuth from \"next-auth\";\n\nconst handler = NextAuth(authOptions);\n\nexport { handler as GET, handler as POST };"],"names":[],"mappings":";;;;;;AAAA;AACA;;;AAEA,MAAM,UAAU,IAAA,kJAAQ,EAAC,4HAAW"}}]
}